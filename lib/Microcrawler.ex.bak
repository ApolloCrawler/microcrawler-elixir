defmodule Microcrawler.Supervisor do
    use Supervisor

    def start_link do
        Supervisor.start_link(__MODULE__, :ok)
    end

    def init(:ok) do
        children = []

        supervise(children, strategy: :one_for_one)
    end
end

defmodule MicrocrawlerOld do
  use Application

  def start_link(name) do
    GenServer.start_link(__MODULE__, :ok, name: name)
  end

  def start_old(_type, _args) do
    # res = Execjs.eval "'red yellow blue'.split(' ')"
    # Apex.ap res

    # Read config file
    config_path = Path.join([System.user_home(), '.microcrawler', 'config.json'])
    res = case File.read(config_path) do
      {:ok, body}      -> run(parse_config(body))
      {:error, reason} -> Apex.ap reason
    end
    res
  end

  def start(_type, _args) do
    Microcrawler.Supervisor.start_link
  end

  def parse_config(data) do
    Poison.Parser.parse!(data)
  end

  def run(config) do
    # :observer.start

    amqp_uri = config["amqp"]["uri"]

    # Connect to AMQP
    {:ok, conn} = AMQP.Connection.open(amqp_uri)
    {:ok, chan} = AMQP.Channel.open(conn)

    handler = fn(payload, _meta) ->
        IO.puts("Received: #{payload}")
    end

    IO.puts "Starting AMQP"
    Task.start(fn -> AMQP.Queue.subscribe(chan, "collector", handler) end)

    loop
  end

  def loop do
    receive do
        msg -> Apex.ap msg; loop
    end
  end

end
